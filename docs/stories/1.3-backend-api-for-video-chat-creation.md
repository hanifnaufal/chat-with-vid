<!-- Powered by BMADâ„¢ Core -->

# Story 1.3: Backend API for Video Chat Creation

## Status
In Progress

## Story
**As a** Efficient Learner,
**I want** to submit a YouTube URL to the application,
**so that** a new chat can be created and processed.

## Acceptance Criteria
1. A FastAPI endpoint POST /api/chats is created that accepts a YouTube URL.
2. The endpoint creates a new chat record, kicks off an asynchronous job to process the video, and immediately returns a unique chat_id.
3. The asynchronous job retrieves the video's transcript (FR2) and metadata (FR3).
4. The job saves the transcript and metadata associated with the chat record.
5. The endpoint handles errors gracefully (e.g., invalid URL) and returns an appropriate error message.
6. The endpoint responds within 2 seconds for valid requests (NFR2 alignment).
7. Error responses follow a consistent JSON format with error code and message fields.

## Tasks / Subtasks
- [x] Task 1: Create POST /api/chats endpoint (AC: 1, 2, 5)
  - [x] Subtask 1.1: Define Pydantic schema for request body
  - [x] Subtask 1.2: Implement endpoint logic to create chat record
  - [x] Subtask 1.3: Add input validation for YouTube URL
  - [x] Subtask 1.4: Implement error handling for invalid URLs
- [ ] Task 2: Implement asynchronous video processing (AC: 3, 4)
  - [ ] Subtask 2.1: Create background task for video processing
  - [ ] Subtask 2.2: Implement YouTube transcript retrieval
  - [ ] Subtask 2.3: Implement YouTube metadata retrieval
  - [ ] Subtask 2.4: Update chat record with transcript and metadata
- [ ] Task 3: Update API router and main application
  - [ ] Subtask 3.1: Register new endpoint in API router
  - [ ] Subtask 3.2: Ensure proper API versioning

## Dev Notes

### Implementation Plan

Based on the architecture documents, we need to implement the following components:

1. **API Endpoint**: Create a new POST endpoint at `/api/v1/chats` that accepts a YouTube URL and returns a chat_id
2. **Data Models**: Use the Chat model defined in the architecture
3. **Services**: Implement the Video Processing Service to handle transcript and metadata retrieval
4. **Repository Pattern**: Use the Persistence Service to interact with the database
5. **Asynchronous Processing**: Implement background tasks for video processing using threading or a task queue
6. **Security**: Implement strict URL validation to prevent SSRF and other security vulnerabilities

### Relevant Architecture Documents

- [Architecture - REST API Spec](/home/hanifnaufal/Projects/chat-with-vid/docs/architecture/8-rest-api-spec.md)
- [Architecture - Data Models](/home/hanifnaufal/Projects/chat-with-vid/docs/architecture/4-data-models.md)
- [Architecture - Components](/home/hanifnaufal/Projects/chat-with-vid/docs/architecture/5-components.md)
- [Architecture - Core Workflows](/home/hanifnaufal/Projects/chat-with-vid/docs/architecture/7-core-workflows.md)
- [Architecture - Tech Stack](/home/hanifnaufal/Projects/chat-with-vid/docs/architecture/3-tech-stack.md)

### Technology Considerations

- Use FastAPI for the API endpoint implementation
- Use SQLAlchemy for database interactions (Repository Pattern)
- Use youtube-transcript-api library for transcript retrieval
- Use asynchronous processing with background tasks
- Follow coding standards defined in architecture/13-coding-standards.md

### QA References

- [Risk Profile](/home/hanifnaufal/Projects/chat-with-vid/docs/qa/risk-profile-1.3-backend-api-for-video-chat-creation.md)
- [Test Design](/home/hanifnaufal/Projects/chat-with-vid/docs/qa/test-design-1.3-backend-api-for-video-chat-creation.md)

## Change Log

## Dev Agent Record

### Agent Model Used
James (Full Stack Developer)

### Debug Log References

### Completion Notes List
1. Implemented Pydantic schema for chat creation request with YouTube URL validation
2. Created custom exception classes for URL validation errors
3. Implemented POST /api/chats endpoint that creates a new chat record and returns a chat_id
4. Added comprehensive URL validation for YouTube URLs
5. Implemented proper error handling for invalid URLs
6. Wrote unit tests for schema validation and URL validation logic
7. Wrote integration tests for the endpoint
8. All tests are passing

### File List
- apps/api/app/schemas/chat.py
- apps/api/app/core/exceptions.py
- apps/api/app/models/chat.py
- apps/api/app/core/database.py
- apps/api/app/repository/chat.py
- apps/api/app/services/chat.py
- apps/api/app/api/v1/chats.py
- apps/api/app/main.py
- apps/api/tests/test_chat_schema.py
- apps/api/tests/test_url_validation.py
- apps/api/tests/test_chats_endpoint.py

## QA Results

Story validated and approved for development. See detailed validation results in [1.3-backend-api-for-video-chat-creation-validation.md](1.3-backend-api-for-video-chat-creation-validation.md).

Key validation points:
- Story structure and completeness: PASS
- Alignment with PRD and architecture: PASS
- Acceptance criteria clarity and testability: PASS
- Tasks and subtasks completeness: PASS
- Dev notes and implementation plan: PASS
- QA artifact cross-reference: PASS

## Recommendations Implemented
1. Enhanced acceptance criteria with response time requirement (AC #6)
2. Specified error response format (AC #7)
3. Added security considerations to implementation plan
4. Added references to QA documents in dev notes
