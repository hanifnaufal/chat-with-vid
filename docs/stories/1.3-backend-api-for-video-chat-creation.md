<!-- Powered by BMADâ„¢ Core -->

# Story 1.3: Backend API for Video Chat Creation and Retrieval

## Status
Completed

## Story
**As a** Efficient Learner,
**I want** to submit a YouTube URL to the application and retrieve chat details,
**so that** a new chat can be created and its processing status can be checked.

## Acceptance Criteria
1. A FastAPI endpoint POST /api/chats is created that accepts a YouTube URL.
2. The endpoint creates a new chat record, kicks off an asynchronous job to process the video, and immediately returns a unique chat_id.
3. The asynchronous job retrieves the video's transcript (FR2) and metadata (FR3).
4. The job saves the transcript and metadata associated with the chat record.
5. The endpoint handles errors gracefully (e.g., invalid URL) and returns an appropriate error message.
6. The endpoint responds within 2 seconds for valid requests (NFR2 alignment).
7. Error responses follow a consistent JSON format with error code and message fields.
8. A FastAPI endpoint GET /api/chats/{chat_id} is created that retrieves chat details by ID.
9. The GET endpoint returns the chat record with its current status and processing results.
10. The GET endpoint handles the case where a chat ID doesn't exist and returns an appropriate error message.

## Tasks / Subtasks
- [x] Task 1: Create POST /api/chats endpoint (AC: 1, 2, 5)
  - [x] Subtask 1.1: Define Pydantic schema for request body
  - [x] Subtask 1.2: Implement endpoint logic to create chat record
  - [x] Subtask 1.3: Add input validation for YouTube URL
  - [x] Subtask 1.4: Implement error handling for invalid URLs
- [x] Task 2: Implement asynchronous video processing (AC: 3, 4)
  - [x] Subtask 2.1: Create background task for video processing
  - [x] Subtask 2.2: Implement YouTube transcript retrieval
  - [x] Subtask 2.3: Implement YouTube metadata retrieval
  - [x] Subtask 2.4: Update chat record with transcript and metadata
- [x] Task 3: Update API router and main application
  - [x] Subtask 3.1: Register new endpoint in API router
  - [x] Subtask 3.2: Ensure proper API versioning
- [x] Task 4: Create GET /api/chats/{chat_id} endpoint (AC: 8, 9, 10)
  - [x] Subtask 4.1: Define Pydantic schema for chat response
  - [x] Subtask 4.2: Implement endpoint logic to retrieve chat by ID
  - [x] Subtask 4.3: Add error handling for non-existent chat IDs
  - [x] Subtask 4.4: Register GET endpoint in API router

## Dev Notes

### Implementation Plan

Based on the architecture documents, we need to implement the following components:

1. **API Endpoint**: Create a new POST endpoint at `/api/v1/chats` that accepts a YouTube URL and returns a chat_id
2. **API Endpoint**: Create a new GET endpoint at `/api/v1/chats/{chat_id}` that retrieves chat details by ID
3. **Data Models**: Use the Chat model defined in the architecture
4. **Services**: Implement the Video Processing Service to handle transcript and metadata retrieval
5. **Repository Pattern**: Use the Persistence Service to interact with the database
6. **Asynchronous Processing**: Implement background tasks for video processing using asyncio
7. **Security**: Implement strict URL validation to prevent SSRF and other security vulnerabilities

### Implementation Details

- Created a new `video.py` service module to handle YouTube transcript and metadata retrieval.
- Enhanced `ChatRepository` with an `update_chat` method to save processing results.
- Modified `ChatService` to start asynchronous video processing using `asyncio.create_task`.
- The asynchronous processing function retrieves transcript and metadata, then updates the chat record.
- Added error handling for video processing errors, updating the chat status to "error" if processing fails.
- Updated API router to use `/api/v1` prefix.
- Created a new GET endpoint at `/api/v1/chats/{chat_id}` to retrieve chat details by ID.
- Implemented proper error handling for non-existent chat IDs in the GET endpoint.

### Relevant Architecture Documents

- [Architecture - REST API Spec](/home/hanifnaufal/Projects/chat-with-vid/docs/architecture/8-rest-api-spec.md)
- [Architecture - Data Models](/home/hanifnaufal/Projects/chat-with-vid/docs/architecture/4-data-models.md)
- [Architecture - Components](/home/hanifnaufal/Projects/chat-with-vid/docs/architecture/5-components.md)
- [Architecture - Core Workflows](/home/hanifnaufal/Projects/chat-with-vid/docs/architecture/7-core-workflows.md)
- [Architecture - Tech Stack](/home/hanifnaufal/Projects/chat-with-vid/docs/architecture/3-tech-stack.md)

### Technology Considerations

- Use FastAPI for the API endpoint implementation
- Use SQLAlchemy for database interactions (Repository Pattern)
- Use youtube-transcript-api library for transcript retrieval
- Use asynchronous processing with background tasks
- Follow coding standards defined in architecture/13-coding-standards.md

### QA References

- [Risk Profile](/home/hanifnaufal/Projects/chat-with-vid/docs/qa/risk-profile-1.3-backend-api-for-video-chat-creation.md)
- [Test Design](/home/hanifnaufal/Projects/chat-with-vid/docs/qa/test-design-1.3-backend-api-for-video-chat-creation.md)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-17 | 1.0 | Initial implementation of asynchronous video processing and API updates | James (Full Stack Developer) |
| 2025-09-18 | 1.1 | Added acceptance criteria and task for GET endpoint to retrieve chat by ID | Product Manager |
| 2025-09-18 | 1.2 | Implemented GET endpoint for chat retrieval and updated story status | James (Full Stack Developer) |
| 2025-09-18 | 1.3 | Refactored GET chat logic into ChatService for cleaner implementation | James (Full Stack Developer) |
| 2025-09-18 | 1.4 | Added comprehensive unit and integration tests for new functionality | James (Full Stack Developer) |

## Dev Agent Record

### Agent Model Used
James (Full Stack Developer)

### Debug Log References

### Completion Notes List
1. Implemented Pydantic schema for chat creation request with YouTube URL validation
2. Created custom exception classes for URL validation errors
3. Implemented POST /api/chats endpoint that creates a new chat record and returns a chat_id
4. Added comprehensive URL validation for YouTube URLs
5. Implemented proper error handling for invalid URLs
6. Created video processing service to retrieve YouTube transcripts and metadata
7. Implemented asynchronous video processing using asyncio
8. Enhanced chat repository to update chat records with processing results
9. Updated API router to use /api/v1 prefix
10. Wrote unit tests for all new services and repository methods
11. Wrote integration tests for the endpoint
12. All tests are passing
13. Code passes Ruff linting and Black formatting checks
14. Created GET /api/chats/{chat_id} endpoint to retrieve chat details by ID
15. Implemented proper error handling for non-existent chat IDs
16. Defined Pydantic schema for chat response
17. Added comprehensive error handling for invalid chat IDs in GET endpoint
18. Added proper logging for all operations in the GET endpoint
19. Ensured all API responses follow the defined schema
20. Verified implementation passes all tests and formatting checks
21. Refactored GET chat logic into ChatService for cleaner implementation
22. Added unit tests for ChatService.get_chat_by_id method
23. Added integration tests for GET /chats/{chat_id} endpoint
24. Improved test coverage for edge cases and error handling

### File List
- apps/api/app/schemas/chat.py
- apps/api/app/core/exceptions.py
- apps/api/app/models/chat.py
- apps/api/app/core/database.py
- apps/api/app/repository/chat.py
- apps/api/app/services/chat.py
- apps/api/app/services/video.py
- apps/api/app/api/v1/chats.py
- apps/api/app/api/v1/__init__.py
- apps/api/app/main.py
- apps/api/tests/test_chat_schema.py
- apps/api/tests/test_url_validation.py
- apps/api/tests/test_chats_endpoint.py
- apps/api/tests/test_chat_service.py
- apps/api/tests/test_chat_repository.py
- apps/api/tests/test_video_service.py

## QA Results

Story validated and approved for development. See detailed validation results in [1.3-backend-api-for-video-chat-creation-validation.md](1.3-backend-api-for-video-chat-creation-validation.md).

Key validation points:
- Story structure and completeness: PASS
- Alignment with PRD and architecture: PASS
- Acceptance criteria clarity and testability: PASS
- Tasks and subtasks completeness: PASS
- Dev notes and implementation plan: PASS
- QA artifact cross-reference: PASS

## Recommendations Implemented
1. Enhanced acceptance criteria with response time requirement (AC #6)
2. Specified error response format (AC #7)
3. Added security considerations to implementation plan
4. Added references to QA documents in dev notes
